<!DOCTYPE html>
<html lang="zh-cn" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>kubernetes05 环境部署 - 梅炜 个人博客</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="meiwei" />
  <meta name="description" content="部署方式 K8S 的安装部署本身还是具有一定的复杂度的, 一般有两种部署方式, 它们也分别会用到不同的工具 软件包的形式安装, 将 K8S 的管理服务以节点上的守护" />

  <meta name="keywords" content="Hugo, theme, jane" />






<meta name="generator" content="Hugo 0.64.1" />


<link rel="canonical" href="https://www.iterdaily.com/post/kubernetes05/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.af20b78e95c84de86b00a0242a4a77bd2601700e1b250edf27537d957ac0041d.css" integrity="sha256-ryC3jpXITehrAKAkKkp3vSYBcA4bJQ7fJ1N9lXrABB0=" media="screen" crossorigin="anonymous">




<link rel="stylesheet" href="/css/custom_code.css">


<meta property="og:title" content="kubernetes05 环境部署" />
<meta property="og:description" content="部署方式 K8S 的安装部署本身还是具有一定的复杂度的, 一般有两种部署方式, 它们也分别会用到不同的工具 软件包的形式安装, 将 K8S 的管理服务以节点上的守护" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.iterdaily.com/post/kubernetes05/" />
<meta property="article:published_time" content="2019-07-14T21:01:23+08:00" />
<meta property="article:modified_time" content="2019-07-14T21:01:23+08:00" />
<meta itemprop="name" content="kubernetes05 环境部署">
<meta itemprop="description" content="部署方式 K8S 的安装部署本身还是具有一定的复杂度的, 一般有两种部署方式, 它们也分别会用到不同的工具 软件包的形式安装, 将 K8S 的管理服务以节点上的守护">
<meta itemprop="datePublished" content="2019-07-14T21:01:23&#43;08:00" />
<meta itemprop="dateModified" content="2019-07-14T21:01:23&#43;08:00" />
<meta itemprop="wordCount" content="4531">



<meta itemprop="keywords" content="k8s,container," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="kubernetes05 环境部署"/>
<meta name="twitter:description" content="部署方式 K8S 的安装部署本身还是具有一定的复杂度的, 一般有两种部署方式, 它们也分别会用到不同的工具 软件包的形式安装, 将 K8S 的管理服务以节点上的守护"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">ITer Daily</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://www.iterdaily.com/">主页</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://www.iterdaily.com/post/">全部文章/存档</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://www.iterdaily.com/tags/">关键词/标签</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://www.iterdaily.com/categories/"> 领域/分类</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://www.iterdaily.com/about/">作者</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          <div class="mobile-menu-parent">
            <span class="mobile-submenu-open"></span>
            <a href="https://www.iterdaily.com/about/">
              友站
            </a>
          </div>
          <ul class="mobile-submenu-list">
            
              <li>
                <a href="https://docs.iterdaily.com">在线文档</a>
              </li>
            
              <li>
                <a href="https://kanban.iterdaily.com">Wekan 看板</a>
              </li>
            
              <li>
                <a href="https://git.iterdaily.com">GitLab 仓库</a>
              </li>
            
              <li>
                <a href="https://jenkins.iterdaily.com">Jenkins 服务器</a>
              </li>
            
          </ul>
        
      </li>
    

    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      ITer Daily
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://www.iterdaily.com/">主页</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://www.iterdaily.com/post/">全部文章/存档</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://www.iterdaily.com/tags/">关键词/标签</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://www.iterdaily.com/categories/"> 领域/分类</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://www.iterdaily.com/about/">作者</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          <a class="menu-item-link menu-parent" href="https://www.iterdaily.com/about/">友站</a>
          <ul class="submenu">
            
              <li>
                <a href="https://docs.iterdaily.com">在线文档</a>
              </li>
            
              <li>
                <a href="https://kanban.iterdaily.com">Wekan 看板</a>
              </li>
            
              <li>
                <a href="https://git.iterdaily.com">GitLab 仓库</a>
              </li>
            
              <li>
                <a href="https://jenkins.iterdaily.com">Jenkins 服务器</a>
              </li>
            
          </ul>

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">kubernetes05 环境部署</h1>
      
      <div class="post-meta">
        <time datetime="2019-07-14" class="post-time">
          2019-07-14
        </time>
        <div class="post-category">
            <a href="https://www.iterdaily.com/categories/cloud/"> Cloud </a>
            
          </div>
        

        
        
          <span id="busuanzi_container_page_pv">
            | 阅读 <span id="busuanzi_value_page_pv"></span>
          </span>
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#部署方式">部署方式</a></li>
    <li><a href="#网络规划">网络规划</a></li>
    <li><a href="#节点环境准备">节点环境准备</a>
      <ul>
        <li></li>
      </ul>
    </li>
    <li><a href="#安装配置步骤">安装配置步骤:</a>
      <ul>
        <li><a href="#安装软件">安装软件</a></li>
        <li><a href="#修改-docker-cgoup-driver-为-systemd-选做">修改 docker cgoup driver 为 systemd (选做)</a></li>
        <li><a href="#调整系统-swap-配置">调整系统 swap 配置</a></li>
        <li><a href="#初始化-master">初始化 master</a></li>
        <li><a href="#安装-flannel-network-add-on">安装 flannel network add-on</a></li>
        <li><a href="#如何重新生成-token">如何重新生成 token</a></li>
        <li><a href="#添加-node-节点到集群">添加 node 节点到集群</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <h2 id="部署方式">部署方式</h2>
<p>K8S 的安装部署本身还是具有一定的复杂度的, 一般有两种部署方式, 它们也分别会用到不同的工具</p>
<ul>
<li>软件包的形式安装, 将 K8S 的管理服务以节点上的守护进程的方式进行运行, 节点配置各种服务daemon, docker.</li>
<li>容器镜像的方式安装, 将 K8S 的服务也以 Pod 的方式运行, 节点安装 kubelet, docker.</li>
</ul>
<p>采用第一种方式, 平台需要准备多套CA, 需要在各个角色节点安装对应的组件, api-server, scheduler, controller等都需要独立运行, 这样的部署通常都会借助一定的部署工具来完成, 例如 ansible role 的方式编排各个节点上的服务, (mini kube 之类的单节点部署工具只能用于简单测试, 是不具备模拟生产环境深入学习的能力的). 其中, K8S 相关的软件源需要配置好, 也可以自己下载源代码编译到本地安装.</p>
<p>而第二种, 我们可以采用官方推荐的 kube-adm 部署,  kube-adm 将 kubelet 以外的所有组件都以容器方式进行部署, 将服务容器话简化了部署难度. 这里需要注意两点:</p>
<ul>
<li>kubeadm 部署的 K8S 服务 Pod 是静态的, 这些 Pod 并未被 K8S 集群托管.</li>
<li>kube-adm 的所有容器镜像都托管在 gcr 的容器托管仓库中, 而出于一些(不可描述的)原因, 国内是无法访问到的, 因此使用起来也需要费一番周折.</li>
</ul>
<p>我们这里实验准备用 kubeadm 创建一个单控制节点的 kubenetes 集群来学习 K8S , 因为 master 节点之间是主备以保障高可用并没有复杂的服务的中间状态和逻辑关系, 所以单主节点是不影响我们的学习的, 在部署之前我们先看一下服务结构</p>
<pre><code>
+-----------------------------------------------+
| +------------------------+ +----------------+ |
| | kube controller manager| | kube scheduler | |
| +-----------------+------+ +--+-------------+ |
|                    |          |               |
|  +-----------------+----------+-+   +-------+ |
|  |      kube api server         +---+ etcd  | |
|  +---+-----------+--------------+   +-------+ |
|      |           |                            |
+-----------------------------------------------+
       |           |
 +------------------------+ +-------+  +-------+
 |     |           |      | |       |  |       |
 | +---+---+ +-----+----+ | |       |  |       |
 | |kubelet| |kube proxy| | |       |  |       |
 | +-------+ +----------+ | | node2 |  | node3 |
 |           +----------+ | |       |  |       |
 | node1     |  docker  | | |       |  |       |
 |           +----------+ | |       |  |       |
 +------------------------+ +---+---+  +---+---+
                 |              |          |
 +---------------+--------------+----------+---+
 |              docker registry                |
 +---------------------------------------------+
</code></pre><p>1.这里的 etcd 在实际生产最好可以独立出来并且以集群的方式运行, 实验环境下可以直接部署在主节点上.</p>
<p>2.这里的 docker-registry 应该是独立的, 企业内我们通常有配置好的可用仓库 (K8S 本身的服务镜像也可以放在上面), 这里为了简化部署我们没有配置独立的 registry 而是采用公用镜像仓库中的镜像来配置我们的应用.</p>
<h2 id="网络规划">网络规划</h2>
<pre><code>
Service Net ------------------+--------------+--------------+--10.96.0.0/12
                              |              |              |
+-MASTER-&amp;-ETCD----+  +-Node1-|---+  +-Node2-|---+  +-Node3-|---+
|API Server &amp; etcd |  | kube proxy|  | kube proxy|  | kube proxy|
|controller manager|  |kubelet    |  |kubelet    |  |kubelet    |
|scheduler         |  |docker     |  |docker     |  |docker     |
|           flannel|  |    flannel|  |    flannel|  |    flannel|
+---------+--------+  +--+---|----+  +--+---|----+  +--+---|----+
          |              |   |          |   |          |   |
Node Net--+--------------+--------------+--------------+------192.168.3.0/24
                             |              |              |
              Pod Net--------+--------------+--------------+---10.224.0.0/16

</code></pre><p>Service 网络: 10.96.0.0/12</p>
<p>Node 网络: 192.168.3.0/24</p>
<p>Pod 网络: 10.224.0.0/16</p>
<h2 id="节点环境准备">节点环境准备</h2>
<p>这里操作系统使用的:  CentOS 7.3</p>
<table>
<thead>
<tr>
<th>节点</th>
<th>节点IP</th>
</tr>
</thead>
<tbody>
<tr>
<td>master, etcd</td>
<td>192.168.3.91</td>
</tr>
<tr>
<td>node1</td>
<td>192.168.3.88</td>
</tr>
<tr>
<td>node2</td>
<td>192.168.3.89</td>
</tr>
</tbody>
</table>
<h4 id="主机环境预配置">主机环境预配置</h4>
<p>这里的前 4 项检查必须完成, 为了避免错误建议你全部完成. 随着版本的更新这些内容可能会有变化, 你可以参考官方文档的 <a href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#check-required-ports">安装kubeadm</a> 了解最新版本的安装准备工作.</p>
<ol>
<li>
<p>基于主机名的局域网解析通信, /etc/hosts;</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># cat /etc/hosts</span>
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6

192.168.3.91 master.iterdaily.com master
192.168.3.88  node1.iterdaily.com node1
192.168.3.89  node2.iterdaily.com node2
</code></pre></div></li>
<li>
<p>确保节点时间同步正常;</p>
</li>
<li>
<p>确保关闭 firewalld, iptables.service</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">systemctl disable firewalld ; systemctl stop firewalld
</code></pre></div></li>
<li>
<p>关闭 selinux</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># 将 SELinux 设置为 permissive 模式（相当于将其禁用）</span>
setenforce <span style="color:#ae81ff">0</span>
sed -i <span style="color:#e6db74">&#39;s/^SELINUX=enforcing$/SELINUX=permissive/&#39;</span> /etc/selinux/config
</code></pre></div><blockquote>
<p><strong>请注意：</strong>
通过运行命令 <code>setenforce 0</code> 和 <code>sed ...</code> 将 SELinux 设置为 permissive 模式可以有效的将其禁用。 这是允许容器访问主机文件系统所必须的，例如正常使用 pod 网络。 您必须这么做，直到 kubelet 做出升级支持 SELinux 为止。</p>
</blockquote>
</li>
<li>
<p>内核 lvs 模块检查 (如果默认的 lvs 出现加载异常则会回退使用 iptables )</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># lvs 模块: ip_vs, ip_vs_rr, ip_vs_wrr, ip_vs_sh, nf_conntrack_ipv4</span>
lsmod |grep -E <span style="color:#e6db74">&#34;ip_vs|nf_contrack&#34;</span> ip_vs
ip_vs_rr
ip_vs_wrr
ip_vs_sh
nf_conntrack_ipv4
ip_vs_sh               <span style="color:#ae81ff">12688</span>  <span style="color:#ae81ff">0</span> 
ip_vs_wrr              <span style="color:#ae81ff">12697</span>  <span style="color:#ae81ff">0</span> 
ip_vs_rr               <span style="color:#ae81ff">12600</span>  <span style="color:#ae81ff">0</span> 
ip_vs                 <span style="color:#ae81ff">145497</span>  <span style="color:#ae81ff">6</span> ip_vs_rr,ip_vs_sh,ip_vs_wrr
nf_conntrack          <span style="color:#ae81ff">139264</span>  <span style="color:#ae81ff">7</span> ip_vs,...,nf_conntrack_ipv4
   
<span style="color:#75715e"># 配置自动加载</span>
cat &gt; /etc/sysconfig/modules/ipvs.modules <span style="color:#e6db74">&lt;&lt;EOF
</span><span style="color:#e6db74">#!/bin/bash
</span><span style="color:#e6db74">modprobe -- ip_vs
</span><span style="color:#e6db74">modprobe -- ip_vs_rr
</span><span style="color:#e6db74">modprobe -- ip_vs_wrr
</span><span style="color:#e6db74">modprobe -- ip_vs_sh
</span><span style="color:#e6db74">modprobe -- nf_conntrack_ipv4
</span><span style="color:#e6db74">EOF</span>
chmod <span style="color:#ae81ff">755</span> /etc/sysconfig/modules/ipvs.modules <span style="color:#f92672">&amp;&amp;</span> bash /etc/sysconfig/modules/ipvs.modules <span style="color:#f92672">&amp;&amp;</span> lsmod | grep -e ip_vs -e nf_conntrack_ipv4
   
<span style="color:#75715e"># 为了方便查看 lvs 规则, 建议安装 lvsadm</span>
yum install ipvsadm ipset
</code></pre></div></li>
<li>
<p>(红帽系OS) 配置系统  <code>net.bridge.bridge-nf-call-iptables</code> 设置为 1</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># 先检查 br_netfilter 模块</span>
lsmod | grep br_netfilter
<span style="color:#75715e"># 执行模块加载</span>
modprobe br_netfilter
   
<span style="color:#75715e"># 配置规则自动加载</span>
cat <span style="color:#e6db74">&lt;&lt;EOF &gt;  /etc/sysctl.d/k8s.conf
</span><span style="color:#e6db74">net.bridge.bridge-nf-call-ip6tables = 1
</span><span style="color:#e6db74">net.bridge.bridge-nf-call-iptables = 1
</span><span style="color:#e6db74">EOF</span>
sysctl --system
</code></pre></div><blockquote>
<p>一些 RHEL/CentOS 7 的用户曾经遇到过问题：由于 iptables 被绕过而导致流量无法正确路由的问题</p>
</blockquote>
</li>
</ol>
<h4 id="各个服务的分布">各个服务的分布</h4>
<ol>
<li>etcd cluster      master 节点</li>
<li>flannel              所有节点</li>
<li>配置master      master节点
<ol>
<li>kube-apiserver</li>
<li>kube-scheduler</li>
<li>kube-controller-manager</li>
</ol>
</li>
<li>配置node节点
<ol>
<li>docker 服务</li>
<li>kube-proxy</li>
<li>kubelet</li>
</ol>
</li>
</ol>
<h2 id="安装配置步骤">安装配置步骤:</h2>
<p>准备 kubeadm 部署工具</p>
<ol>
<li>master, nodes: 安装kubelet, kubeadm, docker</li>
<li>master: kubeadm init</li>
<li>nodes: kubeadm join</li>
</ol>
<p>更多关于 kubeadm 的信息参见 kubernetes/kubeadm <a href="https://github.com/kubernetes/kubeadm/tree/master/docs/design">设计文档参考</a></p>
<blockquote>
<p>使用 kubeadm 部署需要安装的是kubeadm, 在自行下载源代码的时候, 在 kubernetes 代码仓库 release 中 server 包用于本地运行服务守护进程, <em>client 包用于连接登录 K8S 平台进行管理操作</em> , 其实不是必要组件.</p>
</blockquote>
<h3 id="安装软件">安装软件</h3>
<ol>
<li>
<h4 id="kubelet-kubeadm-kubectl-安装">kubelet kubeadm kubectl 安装</h4>
</li>
</ol>
<p>配置 kubernetes 源, 并安装 k8s, 除了 master 节点, 其实其他节点可以不用安装 kubectl.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># 生成 kubernetes.repo</span>
cat <span style="color:#e6db74">&lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo
</span><span style="color:#e6db74">[kubernetes]
</span><span style="color:#e6db74">name=Kubernetes
</span><span style="color:#e6db74">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
</span><span style="color:#e6db74">enabled=1
</span><span style="color:#e6db74">gpgcheck=1
</span><span style="color:#e6db74">repo_gpgcheck=1
</span><span style="color:#e6db74">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
</span><span style="color:#e6db74">EOF</span>
<span style="color:#75715e"># 关闭 selinux</span>
setenforce <span style="color:#ae81ff">0</span>
<span style="color:#75715e"># 安装 kubelet kubeadm kubectl</span>
yum install -y kubelet kubeadm kubectl
systemctl enable kubelet <span style="color:#f92672">&amp;&amp;</span> systemctl start kubelet
</code></pre></div><p>此时查看 kubelet 服务状态, 因为环境还未初始化没有对应的配置文件, 此时 kubelet 还不能正常运行</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># systemctl status kubelet</span>
● kubelet.service - kubelet: The Kubernetes Node Agent
   Loaded: loaded <span style="color:#f92672">(</span>/usr/lib/systemd/system/kubelet.service; enabled; vendor preset: disabled<span style="color:#f92672">)</span>
  Drop-In: /usr/lib/systemd/system/kubelet.service.d
           └─10-kubeadm.conf
   Active: activating <span style="color:#f92672">(</span>auto-restart<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>Result: exit-code<span style="color:#f92672">)</span> since 日 2019-05-17 02:09:58 EDT; 1s ago
     Docs: https://kubernetes.io/docs/
  Process: <span style="color:#ae81ff">13621</span> ExecStart<span style="color:#f92672">=</span>/usr/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS <span style="color:#f92672">(</span>code<span style="color:#f92672">=</span>exited, status<span style="color:#f92672">=</span>255<span style="color:#f92672">)</span>
 Main PID: <span style="color:#ae81ff">13621</span> <span style="color:#f92672">(</span>code<span style="color:#f92672">=</span>exited, status<span style="color:#f92672">=</span>255<span style="color:#f92672">)</span>

5月 <span style="color:#ae81ff">17</span> 02:09:58 master systemd<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>: Unit kubelet.service entered failed state.
5月 <span style="color:#ae81ff">17</span> 02:09:58 master systemd<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>: kubelet.service failed.

<span style="color:#75715e"># tail /var/log/messages</span>
May <span style="color:#ae81ff">17</span> 02:11:21 192e168e59e119 systemd: Started kubelet: The Kubernetes Node Agent.
May <span style="color:#ae81ff">17</span> 02:11:21 192e168e59e119 kubelet: F0517 02:11:21.233633   <span style="color:#ae81ff">13691</span> server.go:199<span style="color:#f92672">]</span> failed to load Kubelet config file /var/lib/kubelet/config.yaml, error failed to read kubelet config file <span style="color:#e6db74">&#34;/var/lib/kubelet/config.yaml&#34;</span>, error: open /var/lib/kubelet/config.yaml: no such file or directory
May <span style="color:#ae81ff">17</span> 02:11:21 192e168e59e119 systemd: kubelet.service: main process exited, code<span style="color:#f92672">=</span>exited, status<span style="color:#f92672">=</span>255/n/a
May <span style="color:#ae81ff">17</span> 02:11:21 192e168e59e119 systemd: Unit kubelet.service entered failed state.
May <span style="color:#ae81ff">17</span> 02:11:21 192e168e59e119 systemd: kubelet.service failed.
May <span style="color:#ae81ff">17</span> 02:11:21 192e168e59e119 systemd: Stopped kubelet: The Kubernetes Node Agent.

<span style="color:#75715e"># 先停止 kubelet 服务</span>
systemctl stop kubelet
</code></pre></div><ol start="2">
<li>
<h4 id="docker-ce-安装">docker-ce 安装</h4>
</li>
</ol>
<p>配置 docker 源, 并安装 docker-ce, 生产环境需要根据要求指定具体的安装版本.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># step 1: 安装必要的一些系统工具</span>
sudo yum install -y yum-utils device-mapper-persistent-data lvm2
<span style="color:#75715e"># Step 2: 添加软件源信息</span>
sudo yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
<span style="color:#75715e"># Step 3: 更新并安装Docker-CE</span>
sudo yum makecache fast
sudo yum -y install docker-ce
<span style="color:#75715e"># Step 4: 开启Docker服务</span>
sudo service docker start

<span style="color:#75715e"># 注意：</span>
<span style="color:#75715e"># 官方软件源默认启用了最新的软件，您可以通过编辑软件源的方式获取各个版本的软件包。例如官方并没有将测试版本的软件源置为可用，您可以通过以下方式开启。同理可以开启各种测试版本等。</span>
<span style="color:#75715e"># vim /etc/yum.repos.d/docker-ee.repo</span>
<span style="color:#75715e">#   将[docker-ce-test]下方的enabled=0修改为enabled=1</span>
#
<span style="color:#75715e"># 安装指定版本的Docker-CE:</span>
<span style="color:#75715e"># Step 1: 查找Docker-CE的版本:</span>
<span style="color:#75715e"># yum list docker-ce.x86_64 --showduplicates | sort -r</span>
<span style="color:#75715e">#   Loading mirror speeds from cached hostfile</span>
<span style="color:#75715e">#   Loaded plugins: branch, fastestmirror, langpacks</span>
<span style="color:#75715e">#   docker-ce.x86_64            17.03.1.ce-1.el7.centos            docker-ce-stable</span>
<span style="color:#75715e">#   docker-ce.x86_64            17.03.1.ce-1.el7.centos            @docker-ce-stable</span>
<span style="color:#75715e">#   docker-ce.x86_64            17.03.0.ce-1.el7.centos            docker-ce-stable</span>
<span style="color:#75715e">#   Available Packages</span>
<span style="color:#75715e"># Step2: 安装指定版本的Docker-CE: (VERSION例如上面的17.03.0.ce.1-1.el7.centos)</span>
<span style="color:#75715e"># sudo yum -y install docker-ce-[VERSION]</span>
</code></pre></div><p>不得不说一下, <em>阿里源的帮助说明还是很细致的</em> .</p>
<p>记得配置 docker 开机启动, <code>sudo systemctl enable docker</code></p>
<h3 id="修改-docker-cgoup-driver-为-systemd-选做">修改 docker cgoup driver 为 systemd (选做)</h3>
<p>CRI installation 中指出，对于使用 systemd 作为 init system 的 Linux 的发行版，使用 systemd 作为 Docker 的 cgroup driver 可以确保服务器节点在资源紧张的情况更加稳定，因此这里修改各个节点上 Docker 的 cgroup driver 为 systemd.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># vim /etc/docker/daemon.json</span>
<span style="color:#f92672">{</span>
  <span style="color:#e6db74">&#34;exec-opts&#34;</span>: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;native.cgroupdriver=systemd&#34;</span><span style="color:#f92672">]</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e"># systemctl daemon-reload &amp;&amp; systemctl restart docker</span>
</code></pre></div><blockquote>
<p>这里我们最好在整个集群都统一调整.</p>
<p>重启 docker 服务后, 使用 <code>docker info</code> 可以看到 <code>Cgroup Driver: systemd</code> 即可.</p>
</blockquote>
<h3 id="调整系统-swap-配置">调整系统 swap 配置</h3>
<p>Kubernetes 1.8开始要求关闭系统的Swap，如果不关闭，默认配置下kubelet将无法启动.</p>
<h4 id="关闭-swap">关闭 swap</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># 关闭当前系统 swap</span>
swapoff -a
</code></pre></div><p>修改 /etc/fstab 文件，注释掉 SWAP 的自动挂载，使用free -m确认swap已经关闭</p>
<p>swappiness参数调整，修改 <code>/etc/sysctl.d/k8s.conf</code> 添加下面一行：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">vm</span>.<span style="color:#a6e22e">swappiness</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</code></pre></div><p>执行 <code>sysctl -p /etc/sysctl.d/k8s.conf</code> 使修改生效.</p>
<p>因为 docker 容器不能很好的隔离对于 swap 的使用, 因此, kubernetes 会检查 swap 是否禁用.</p>
<h4 id="如何不关闭-swap-安装">如何不关闭 swap 安装</h4>
<p>如果不想禁用 swap 需要在初始化之前对 kubelet 进行一些配置.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># cat /etc/sysconfig/kubelet</span> 
KUBELET_EXTRA_ARGS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;--fail-swap-on=false&#34;</span>
</code></pre></div><p>同时, 初始化参数也要加上 <code>--ignore-preflight-errors=Swap</code> , 这里实验的虚拟机配置不高, 所以就开着 swap 继续配置.</p>
<h3 id="初始化-master">初始化 master</h3>
<p>运行 <code>kubeadm init</code> 初始化命令</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubeadm init --kubernetes-version<span style="color:#f92672">=</span>v1.14.1 --pod-network-cidr<span style="color:#f92672">=</span>10.224.0.0/16 --service-cidr<span style="color:#f92672">=</span>10.96.0.0/12 --image-repository registry.aliyuncs.com/google_containers --ignore-preflight-errors<span style="color:#f92672">=</span>Swap 
</code></pre></div><p>这些参数要根据你的安装版本和环境的网络进行修改:</p>
<ul>
<li><code>--kubernetes-version</code>  kubernetes 版本</li>
<li><code>--pod-network-cidr</code>     Pod 网络地址</li>
<li><code>--service-cidr</code>    Service 网络地址</li>
<li><code>--image-repository</code> 使用的代理镜像仓库地址, 国内无法直接获取 k8s 镜像</li>
<li><code>--ignore-preflight-errors</code>  忽略 swap 错误</li>
</ul>
<h4 id="使用国内的-k8s-镜像仓库">使用国内的 K8S 镜像仓库</h4>
<p>这里因为 kubernetes 镜像从国内难以访问, 所以在拉取镜像的过程我们需要指定代理的地址, 如果没有配置代理从镜像仓库下载就会看到下面的报错信息:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#f92672">[</span>preflight<span style="color:#f92672">]</span> Pulling images required <span style="color:#66d9ef">for</span> setting up a Kubernetes cluster
<span style="color:#f92672">[</span>preflight<span style="color:#f92672">]</span> This might take a minute or two, depending on the speed of your internet connection
<span style="color:#f92672">[</span>preflight<span style="color:#f92672">]</span> You can also perform this action in beforehand using <span style="color:#e6db74">&#39;kubeadm config images pull&#39;</span>
error execution phase preflight: <span style="color:#f92672">[</span>preflight<span style="color:#f92672">]</span> Some fatal errors occurred:
	<span style="color:#f92672">[</span>ERROR ImagePull<span style="color:#f92672">]</span>: failed to pull image k8s.gcr.io/kube-apiserver:v1.14.1: output: Error response from daemon: Get https://k8s.gcr.io/v2/: net/http: request canceled <span style="color:#66d9ef">while</span> waiting <span style="color:#66d9ef">for</span> connection <span style="color:#f92672">(</span>Client.Timeout exceeded <span style="color:#66d9ef">while</span> awaiting headers<span style="color:#f92672">)</span>
, error: exit status <span style="color:#ae81ff">1</span>
</code></pre></div><p>手动从国内的镜像源拉取 k8s 的镜像, 在各个 node 先拉取好所需要的镜像可以加快部署速度:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># 仅执行拉取镜像</span>
kubeadm config images pull --image-repository registry.aliyuncs.com/google_containers
</code></pre></div><p>或者</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/&lt;镜像名称&gt;:&lt;版本tag&gt;
</code></pre></div><h4 id="用户环境的初始化">用户环境的初始化</h4>
<p>如果初始化 master 的配置没有错误的话, 等待 <code>kubeadm init</code> 初始化完成你将看到类似下面的信息</p>
<pre><code>Your Kubernetes control-plane has initialized successfully!

To start using your cluster, you need to run the following as a regular user:

  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config

You should now deploy a pod network to the cluster.
Run &quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

Then you can join any number of worker nodes by running the following on each as root:

kubeadm join 192.168.3.91:6443 --token gf0l13.k6vtk8pydkb30fat \
    --discovery-token-ca-cert-hash sha256:d0c31c8d83828b7efb296f25b9f39c104a4a676c26fe2b0fe0ce93b667cff8e6
</code></pre><blockquote>
<p>如果你因为一些原因需要重新初始化, 可使用 <code>kubeadm reset</code> 重置当前节点的环境, 不过 <code>$HOME/.kube/</code> 下的配置文件, ipvs / iptables 规则需要手动清除.  如果有其他服务调整请将服务重启.</p>
<p>初始化完成后, 后续的节点添加需要用到这里的 token 信息, 所以我们最好先将这里的信息保存下来.</p>
</blockquote>
<p>初始化完成后, 集群中各个节点并无法建立安全通信, 所以这里加入集群需要使用 token 以保证第一次连接的安全.</p>
<p>如果你需要使用单独的非root用户完成后续的管理工作, 那么这里需要根据提示在家目录下完成用户配置:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># 该用户需要有 sudo 权限</span>
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown <span style="color:#66d9ef">$(</span>id -u<span style="color:#66d9ef">)</span>:<span style="color:#66d9ef">$(</span>id -g<span style="color:#66d9ef">)</span> $HOME/.kube/config
</code></pre></div><blockquote>
<p>后面我们要使用的 kubectl 工具会在执行时在 <code>$HOME/.kube</code> 目录中寻找一个名为 config 的文件, 读取我们的一些环境信息, 诸如集群的认证信息的等.</p>
<p>这里测试中我们也可以直接使用 root 用户完成上面的操作.</p>
</blockquote>
<p>查看一下集群组件状态 (第一次运行会稍慢).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># kubectl get cs</span>
NAME                 STATUS    MESSAGE             ERROR
scheduler            Healthy   ok                  
controller-manager   Healthy   ok                  
etcd-0               Healthy   <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;health&#34;</span>:<span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">}</span> 

<span style="color:#75715e"># kubectl get nodes</span>
NAME     STATUS     ROLES    AGE    VERSION
master   NotReady   master   153m   v1.14.1
</code></pre></div><p>这里看到集群的状态显示的是 <code>NotReady</code> 这是因为当前的集群还没有可用的网络组件, 因此集群是未就绪的.</p>
<h3 id="安装-flannel-network-add-on">安装 flannel network add-on</h3>
<p>关于网络插件我们这里选择 <code>flannel</code> , 对于初级用户而言 flannel 已经提供了足够的功能和性能, 当我们逐渐深入使用在 flannel 已经不能满足要求的时候, 可以再考虑使用其他的插件.</p>
<p>关于 flannel 的安装, 官方建议的安装方法相当简单, 只需一条命令既可</p>
<pre><code>kubectl apply -f   https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
</code></pre><p>不过, 因为一些网络相关原因, 获取 <code>kube-flannel.yml</code> 文件可能会很不方便, 这条命令很可能不会执行成功. 所以我这里也提供了一个下载好的 <code>kube-flannel</code> 文件, 我们可以通过这个缓存下来的文件来部署</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># kubectl apply -f  https://docs.iterdaily.com/kube-flannel.yml</span>
podsecuritypolicy.policy/psp.flannel.unprivileged created
clusterrole.rbac.authorization.k8s.io/flannel created
clusterrolebinding.rbac.authorization.k8s.io/flannel created
serviceaccount/flannel created
configmap/kube-flannel-cfg created
daemonset.apps/kube-flannel-ds-amd64 created
daemonset.apps/kube-flannel-ds-arm64 created
daemonset.apps/kube-flannel-ds-arm created
daemonset.apps/kube-flannel-ds-ppc64le created
daemonset.apps/kube-flannel-ds-s390x created

<span style="color:#75715e"># 执行完成后, 查看一下 flannel pod 状态</span>
<span style="color:#75715e"># kubectl get pods -n kube-system</span>
NAME                             READY   STATUS    RESTARTS   AGE
coredns-7ff77c879f-2scfj         1/1     Running   <span style="color:#ae81ff">0</span>          30h
coredns-7ff77c879f-9kwxq         1/1     Running   <span style="color:#ae81ff">0</span>          30h
etcd-master                      1/1     Running   <span style="color:#ae81ff">1</span>          30h
kube-apiserver-master            1/1     Running   <span style="color:#ae81ff">262</span>        30h
kube-controller-manager-master   1/1     Running   <span style="color:#ae81ff">9</span>          30h
kube-flannel-ds-amd64-rn2ls      1/1     Running   <span style="color:#ae81ff">0</span>          123m
kube-proxy-kzq9f                 1/1     Running   <span style="color:#ae81ff">0</span>          30h
kube-scheduler-master            1/1     Running   <span style="color:#ae81ff">7</span>          30h
</code></pre></div><h3 id="如何重新生成-token">如何重新生成 token</h3>
<p>我这里因实验中间出现了中断导致原来的 token (默认是24小时)已经失效了, 所以我们重新生成一份 token</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># 生成 token</span>
<span style="color:#75715e"># kubeadm token create</span>
W0518 12:48:48.956415   <span style="color:#ae81ff">10093</span> configset.go:202<span style="color:#f92672">]</span> WARNING: kubeadm cannot validate component configs <span style="color:#66d9ef">for</span> API groups <span style="color:#f92672">[</span>kubelet.config.k8s.io kubeproxy.config.k8s.io<span style="color:#f92672">]</span>
jrldwd.tv3nkksbo7ok5206

<span style="color:#75715e"># 我们还需要 master 节点的 ca 证书 sha256 hash值</span> 
<span style="color:#75715e"># openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2&gt;/dev/null | openssl dgst -sha256 -hex | sed &#39;s/^.* //&#39;</span>
eb7bfee5270c182dc5452baeafeabd65bd1a3c6e55073589c5594c1d0ab9eb4d
</code></pre></div><h3 id="添加-node-节点到集群">添加 node 节点到集群</h3>
<p>集群的 master 已经初始化完成了, 我们还需要把剩下的 nodes 添加进来, 不过在 node 节点在添加进集群之前, 建议你最好再检查一遍配置, 尤其是对默认的 cri 以及 swap 做过调整, 尽量去避免以下项目出现操作上的遗漏.</p>
<ul>
<li>docker 服务配置状态, 所使用的 <code>Cgroup Driver</code></li>
<li>kubelet 配置状态与 <code>/etc/sysconfig/kubelet</code> 配置项</li>
</ul>
<p>检查配置完成, 我们到 node 节点执行 <code>kubeadm join</code> , 将节点加入集群</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># kubeadm join 192.168.3.91:6443 --token jrldwd.tv3nkksbo7ok5206     --discovery-token-ca-cert-hash sha256:eb7bfee5270c182dc5452baeafeabd65bd1a3c6e55073589c5594c1d0ab9eb4d     --ignore-preflight-errors=Swap</span>
W0518 12:56:51.713396   <span style="color:#ae81ff">12787</span> join.go:346<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>preflight<span style="color:#f92672">]</span> WARNING: JoinControlPane.controlPlane settings will be ignored when control-plane flag is not set.
<span style="color:#f92672">[</span>preflight<span style="color:#f92672">]</span> Running pre-flight checks
	<span style="color:#f92672">[</span>WARNING Swap<span style="color:#f92672">]</span>: running with swap on is not supported. Please disable swap
<span style="color:#f92672">[</span>preflight<span style="color:#f92672">]</span> Reading configuration from the cluster...
<span style="color:#f92672">[</span>preflight<span style="color:#f92672">]</span> FYI: You can look at this config file with <span style="color:#e6db74">&#39;kubectl -n kube-system get cm kubeadm-config -oyaml&#39;</span>
<span style="color:#f92672">[</span>kubelet-start<span style="color:#f92672">]</span> Downloading configuration <span style="color:#66d9ef">for</span> the kubelet from the <span style="color:#e6db74">&#34;kubelet-config-1.14&#34;</span> ConfigMap in the kube-system namespace
<span style="color:#f92672">[</span>kubelet-start<span style="color:#f92672">]</span> Writing kubelet configuration to file <span style="color:#e6db74">&#34;/var/lib/kubelet/config.yaml&#34;</span>
<span style="color:#f92672">[</span>kubelet-start<span style="color:#f92672">]</span> Writing kubelet environment file with flags to file <span style="color:#e6db74">&#34;/var/lib/kubelet/kubeadm-flags.env&#34;</span>
<span style="color:#f92672">[</span>kubelet-start<span style="color:#f92672">]</span> Starting the kubelet
<span style="color:#f92672">[</span>kubelet-start<span style="color:#f92672">]</span> Waiting <span style="color:#66d9ef">for</span> the kubelet to perform the TLS Bootstrap...

This node has joined the cluster:
* Certificate signing request was sent to apiserver and a response was received.
* The Kubelet was informed of the new secure connection details.

Run <span style="color:#e6db74">&#39;kubectl get nodes&#39;</span> on the control-plane to see this node join the cluster.

</code></pre></div><blockquote>
<p>如果 node 节点的swap 是开启的不要忘记使用 <code>--ignore-preflight-errors=Swap</code> 选项</p>
</blockquote>
<p>节点加入完成后, kubelet 会在各个节点安装相关服务和网络插件, 我们可以先到 master 节点查看一下 节点状态</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># kubectl get nodes</span>
NAME     STATUS   ROLES    AGE     VERSION
master   Ready    master   31h     v1.14.1
node1    Ready    &lt;none&gt;   6m      v1.14.1
node2    NotReady &lt;none&gt;   4m29s   v1.14.1

<span style="color:#75715e"># 等待节点都初始化完成</span>
<span style="color:#75715e"># kubectl get nodes</span>
NAME     STATUS   ROLES    AGE     VERSION
master   Ready    master   31h     v1.14.1
node1    Ready    &lt;none&gt;   10m     v1.14.1
node2    Ready    &lt;none&gt;   1m29s   v1.14.1

<span style="color:#75715e"># kubectl get pods -n kube-system</span>
NAME                             READY   STATUS    RESTARTS   AGE
coredns-7ff77c879f-2scfj         1/1     Running   <span style="color:#ae81ff">0</span>          31h
coredns-7ff77c879f-9kwxq         1/1     Running   <span style="color:#ae81ff">0</span>          31h
etcd-master                      1/1     Running   <span style="color:#ae81ff">1</span>          31h
kube-apiserver-master            1/1     Running   <span style="color:#ae81ff">262</span>        31h
kube-controller-manager-master   1/1     Running   <span style="color:#ae81ff">14</span>         31h
kube-flannel-ds-amd64-chxgv      1/1     Running   <span style="color:#ae81ff">0</span>          22m
kube-flannel-ds-amd64-rn2ls      1/1     Running   <span style="color:#ae81ff">0</span>          3h20m
kube-flannel-ds-amd64-v9dxg      1/1     Running   <span style="color:#ae81ff">0</span>          9m57s
kube-proxy-jtr6k                 1/1     Running   <span style="color:#ae81ff">0</span>          22m
kube-proxy-kzq9f                 1/1     Running   <span style="color:#ae81ff">0</span>          31h
kube-proxy-wjgqz                 1/1     Running   <span style="color:#ae81ff">0</span>          9m57s
kube-scheduler-master            1/1     Running   <span style="color:#ae81ff">11</span>         31h
</code></pre></div><blockquote>
<p>可以试着使用 <code>kubectl get pods -n kube-system -o wide</code> 可以查看更多列信息</p>
</blockquote>
<p>现在集群已经基本安装完成, 接下来我们会使用 k8s 集群完成后续的服务管理.</p>

    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">meiwei</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
      2019-07-14
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://www.iterdaily.com/tags/k8s/">k8s</a>
          <a href="https://www.iterdaily.com/tags/container/">container</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/kubernetes06/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">kubernetes06 kubectl命令</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        
          <a class="next" href="/post/kubernetes04/">
            <span class="next-text nav-default">kubernetes04 网络基础</span>
            <span class="prev-text nav-mobile">下一篇</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  

  
  

  

  

  

    

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:williammei@126.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://github.com/will-mei" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>
  
    <a href="https://git.iterdaily.com" rel="me noopener" class="iconfont"
      title="gitlab"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M59.544137 403.419429L512.115566 983.405714 16.09728 623.396571a39.936 39.936 0 0 1-14.299429-43.995428l57.709715-176.018286z m264.009143 0h377.161143L512.152137 983.405714zM210.40128 53.723429l113.152 349.696H59.544137l113.152-349.696a20.041143 20.041143 0 0 1 37.705143 0z m754.285714 349.696l57.709715 176.018285a39.862857 39.862857 0 0 1-14.299429 43.995429l-496.018286 360.009143 452.571429-579.986286z m0 0h-264.009143l113.152-349.696a20.041143 20.041143 0 0 1 37.705143 0z"></path>
</svg>

    </a>
  
    <a href="https://space.bilibili.com/7388823" rel="me noopener" class="iconfont"
      title="bilibili"  target="_blank"
      >
      <svg
  class="icon" style="" viewBox="0 0 1024 1024" version="1.1" width="36"
  height="36" id="svg8">
  <path
      style=""
      d="M 744.60599,0.00486267 A 41.779915,41.779915 0 0 0 710.4184,18.673394 L 548.5048,255.32642 h -11.70046 a 41.779915,41.779915 0 0 0 -10.80295,-7.84928 L 235.66,97.084498 a 41.779915,41.779915 0 0 0 -20.07193,-4.960864 41.779915,41.779915 0 0 0 -18.3748,79.145436 L 359.4859,255.32642 H 128.16909 c -49.458302,0 -89.27932,39.82105 -89.27932,89.27932 v 508.65224 c 0,49.4583 39.821018,89.27934 89.27932,89.27934 h 19.48445 C 149.12802,984.5043 179.92773,1024 224.79179,1024 c 44.86407,0 75.66379,-39.4957 77.13826,-81.46268 H 719.98116 C 721.45559,984.5043 752.25533,1024 797.1194,1024 c 44.86406,0 75.6638,-39.4957 77.13824,-81.46268 h 21.57323 c 49.45831,0 89.27936,-39.82104 89.27936,-89.27934 V 344.60574 c 0,-49.45827 -39.82105,-89.27932 -89.27936,-89.27932 H 649.74567 L 779.38103,65.866924 A 41.779915,41.779915 0 0 0 744.60599,0.00486267 Z M 644.49108,418.70871 c 6.29985,0.21538 12.44451,2.01107 17.86888,5.22196 l 171.36218,98.10771 c 18.23417,10.21935 24.63334,33.34627 14.24614,51.48533 -10.38726,18.13909 -33.57344,24.32718 -51.61587,13.77296 L 624.9903,489.18895 c -15.21356,-8.41858 -22.66871,-26.1765 -18.03211,-42.93436 4.63664,-16.75784 20.15573,-28.14465 37.53289,-27.54588 z M 350.2006,432.31846 c 16.89952,0.0317 31.69582,11.33328 36.17844,27.62747 4.48262,16.2942 -2.44981,33.57765 -16.95507,42.24898 l -140.7157,86.91312 c -17.68528,11.18244 -41.09629,5.77692 -52.08912,-12.02686 -10.99282,-17.80373 -5.33855,-41.15658 12.58167,-51.95857 L 329.9002,438.2095 c 6.0643,-3.86439 13.10951,-5.90891 20.3004,-5.89104 z M 501.605,641.53985 c 3.75002,-0.15248 7.48645,0.53903 10.93349,2.0235 0.15842,0.0637 0.31618,0.12888 0.47325,0.19582 0.59328,0.27092 1.17574,0.56489 1.74609,0.88121 0.15868,0.0854 0.31643,0.17233 0.47325,0.2611 0.55694,0.32165 1.10131,0.66458 1.63185,1.02807 0.16455,0.1123 0.32777,0.2265 0.48956,0.34269 0.50382,0.36781 0.99371,0.75428 1.46868,1.15864 0.18724,0.15504 0.37218,0.31282 0.55484,0.47323 0.43271,0.38784 0.8518,0.79061 1.25653,1.20756 0.15449,0.16114 0.30679,0.32437 0.45693,0.48959 0.40798,0.44266 0.79989,0.89988 1.17494,1.37076 0.17799,0.22544 0.35205,0.45395 0.5222,0.68538 0.25932,0.34701 0.50964,0.70071 0.75064,1.06071 0.26712,0.39516 0.52286,0.79784 0.76699,1.20757 0.16907,0.29043 0.33231,0.58424 0.48957,0.88123 0.21836,0.41297 0.42513,0.83199 0.62009,1.25653 0.14836,0.32333 0.28983,0.64976 0.42429,0.97911 0.21319,0.51552 0.40915,1.03801 0.58747,1.5666 0.0677,0.19499 0.13296,0.39085 0.19582,0.58748 0.18652,0.60823 0.34984,1.22334 0.48957,1.84399 0.0397,0.16277 0.0779,0.32601 0.11423,0.48957 0.1436,0.69112 0.25788,1.38801 0.34269,2.08877 0.005,0.0381 0.0111,0.0761 0.0163,0.11424 0.0857,0.78056 0.13474,1.56471 0.14687,2.34988 0.005,0.0543 0.0111,0.10879 0.0163,0.1632 0,0 -0.008,1.12132 0,1.45234 0,0 -0.14697,17.84761 5.89102,34.12231 3.01902,8.13734 7.33278,15.10615 12.61433,19.61501 5.28157,4.50889 11.42894,7.62081 23.64572,7.62081 12.2168,0 18.36416,-3.11192 23.64573,-7.62081 5.28154,-4.50886 9.5953,-11.47767 12.6143,-19.61501 6.03799,-16.2747 5.89103,-34.12231 5.89103,-34.12231 -0.44885,-13.87045 10.45922,-25.46302 24.3311,-25.86506 13.87189,-0.40201 25.42828,10.53953 25.78348,24.41272 0,0 1.11929,25.7226 -9.00791,53.01927 -5.06359,13.64832 -13.1986,28.46036 -27.05631,40.29073 -13.85772,11.83039 -33.5454,19.63135 -56.20142,19.63135 -22.65603,0 -42.34371,-7.80096 -56.20141,-19.63135 -4.1801,-3.56856 -7.78733,-7.42433 -10.99878,-11.42303 -3.21235,4.00037 -6.81703,7.85309 -10.99876,11.42303 -13.85773,11.83039 -33.5454,19.63135 -56.20144,19.63135 -22.65601,0 -42.3437,-7.80096 -56.2014,-19.63135 -13.85775,-11.83037 -21.99272,-26.64241 -27.05632,-40.29073 -10.12725,-27.29667 -9.00789,-53.01928 -9.00789,-53.01927 0.20714,-13.83687 11.58744,-24.88848 25.42444,-24.69013 14.1263,0.19991 25.2971,12.0278 24.69011,26.14247 0,0 -0.14697,17.84761 5.89103,34.12231 3.01902,8.13734 7.31646,15.10615 12.598,19.61501 5.28155,4.50889 11.44526,7.62081 23.66203,7.62081 12.21681,0 18.36418,-3.11192 23.64573,-7.62081 5.28154,-4.50886 9.57899,-11.47767 12.598,-19.61501 5.76352,-15.53489 5.89112,-32.05691 5.89103,-33.56746 0.006,-0.37466 0.0111,-1.05336 0.0163,-1.20759 -0.0117,-0.74583 0.0105,-1.49177 0.0652,-2.23565 0.009,-0.15784 0.0204,-0.31561 0.0327,-0.47324 0.14204,-1.56859 0.43163,-3.12027 0.86487,-4.63449 0.0213,-0.0763 0.0433,-0.15244 0.0652,-0.22848 3.0335,-10.25748 12.24157,-17.46007 22.92769,-17.93417 z"
      id="rect824"/>
</svg>

    </a>


<a href="https://www.iterdaily.com/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
     备案 - <a class="theme-link" href="http://www.beian.miit.gov.cn/">京ICP备19054960号-1</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2019 -
    2021
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        WilliamMei
        
      </span></span>

  
  
    <span id="busuanzi_container">
      访客数/访问量：<span id="busuanzi_value_site_uv"></span>/<span id="busuanzi_value_site_pv"></span>
    </span>
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>



  <script type="text/javascript">
    window.MathJax = {
      showProcessingMessages: false,
      messageStyle: 'none'
    };
  </script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML' async></script>









  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  




  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>













<script type="text/javascript" src="//cdn.bootcss.com/viz.js/1.3.0/viz.js"> </script>
<script type="text/javascript">
(function(){
    var vizPrefix = "language-viz-";
    Array.prototype.forEach.call(document.querySelectorAll("[class^=" + vizPrefix + "]"), function(x){
        var engine;
        x.getAttribute("class").split(" ").forEach(function(cls){
            if (cls.startsWith(vizPrefix)) {
                engine = cls.substr(vizPrefix.length);
            }
        });
        var image = new DOMParser().parseFromString(Viz(x.innerText, {format:"svg", engine:engine}), "image/svg+xml");
        x.parentNode.insertBefore(image.documentElement, x);
        x.style.display = 'none'
    });
})();
</script>

</body>
</html>
